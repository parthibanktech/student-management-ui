name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # JOB 1: BUILD AND PUSH
  # This job builds the Angular application into a Docker image (using Nginx) and pushes it to Docker Hub.
  build-and-push-frontend:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout source code
    - uses: actions/checkout@v3

    # 2. Setup Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 3. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 4. Build and Push the Frontend Image
    # 'context: .' means use the Dockerfile in the current directory.
    - name: Build and Push Frontend
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: parthibanktech3/student-management-frontend:latest

  # JOB 2: DEPLOY TO EC2
  # This job runs AFTER the image is successfully pushed.
  deploy-to-ec2:
    needs: build-and-push-frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 2. SSH into EC2 and update the frontend service in the MAIN deployment
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # Navigate to the MAIN deployment directory (managed by Backend Repo)
            cd /home/${{ secrets.EC2_USER }}/student-management-system
            
            echo "Frontend Deployment started..."
            
            # Pull the new Frontend image (pushed in previous job)
            docker-compose pull frontend
            
            # Restart ONLY the frontend service (and Nginx to be safe)
            # This keeps Kafka, DB, and Backend alive!
            docker-compose up -d --no-deps frontend nginx
            
            echo "Frontend updated successfully within the main stack."
