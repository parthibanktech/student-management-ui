name: Frontend CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # JOB 1: BUILD AND PUSH
  # This job builds the Angular application into a Docker image (using Nginx) and pushes it to Docker Hub.
  build-and-push-frontend:
    runs-on: ubuntu-latest
    steps:
    # 1. Checkout source code
    - uses: actions/checkout@v3

    # 2. Setup Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # 3. Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # 4. Build and Push the Frontend Image
    # 'context: .' means use the Dockerfile in the current directory.
    - name: Build and Push Frontend
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: parthibanktech3/student-management-frontend:latest

  # JOB 2: DEPLOY TO EC2
  # This job runs AFTER the image is successfully pushed.
  deploy-to-ec2:
    needs: build-and-push-frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Copy the frontend docker-compose.yml to EC2
      # We put it in a separate folder 'frontend' to avoid conflicting with the backend compose file.
      - name: Copy docker-compose to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "docker-compose.yml"
          target: "/home/${{ secrets.EC2_USER }}/frontend"
          strip_components: 0

      # 2. SSH into EC2 and restart the container
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd /home/${{ secrets.EC2_USER }}/frontend
            
            echo "Frontend Deployment started..."
            
            # Stop old container
            docker-compose down || true
            
            # Pull new image
            docker-compose pull
            
            # Start new container
            docker-compose up -d
            
            echo "Frontend Deployment successful!"
